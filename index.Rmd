---
title: "CPRA Oyster Resource Zones"
output:
  flexdashboard::flex_dashboard:
    navbar:
    theme: yeti
    orientation: columns
    vertical_layout: fill
    logo: www/lynker_logo_white_transparent.png
    css: www/custom.css
runtime: shiny
---

```{r setup, include = FALSE}
# Shiny & Flexdashboard libraries
library(shiny)
library(flexdashboard)

# Data libraries
library(tidyr)
library(dplyr)
library(leaflet)
library(leafem)
library(sf)
library(rgdal)
library(raster)
library(viridisLite)
library(htmlwidgets)
library(htmltools)
library(leaflet.extras)
# library(leaflegend)
library(RColorBrewer)
library(shinyalert)

source('utils.R')
```

<style>
.navbar, [data-toggle=tab], .navbar-brand  {   background-color:#1c3a5d;   border-color:black;   color:white; }

.navbar-logo img {
    position: absolute;
    right: 6px;
}

</style>

```{r context="server"}
# local path to data
path           <- "C:/Users/angus/OneDrive/Desktop/lynker/CPRA/data/"

# # coord ref. system 26915
crs            <- CRS('+init=EPSG:26915')

# # extent for all rasters
ext            <- extent(c(405220, 909700, 3199570, 3416530))

# =====================================
# ---- Commercial Viability layers ----
# =====================================

# Distance to Roads CV
si_road      <- raster::raster("mp2023_si_roads.tif")

# Fetch shallow/deep
si_fetch     <- raster::stack("mp2023_si_fetch.tif")

# Sediment Deposition CV
si_sed_dep   <- raster::raster("mp2023_si_sed_dep.tif")

cv           <- raster::stack("mp2023_commercial_viability.tif")

# Shallow water CV
# shallow_cv <- raster::stack("shallow_cv_mask.tif") %>%
#   setNames(c("shallow_cv_03_03", "shallow_cv_10_10"))
#
# # Deep water CV
# deep_cv <- raster::stack("deep_cv_mask.tif") %>%
#   setNames(c("deep_cv_03_03", "deep_cv_10_10"))


# =================================
# ---- Oyster Viability layers ----
# =================================

si_sal <- raster::stack("mp2023_si_sal.tif")
si_ms  <- raster::raster("mp2023_si_ms.tif")
si_ov  <- raster::raster("mp2023_si_ov.tif")

# =======================
# ---- AOC (CV x OV) ----
# =======================

aoc <- raster::stack("mp2023_aoc.tif")

# ==================
# ---- Polygons ----
# ==================

# AOC
aoc_areas            <- readRDS("aoc_area_polygon.rds") %>%
      st_transform(4326) %>%
      st_union() %>%
      st_as_sf() %>%
      mutate(
        label   = "AOC permitted areas"
        )

# Navigable waterways
waterways      <- readRDS("navig_waterways_buffer_simple.rds") %>%
      st_transform(4326) %>%
      mutate(label = "Navigatable waterways")

# Coastal use permits
cup            <- raster::raster("coastal_use_permits_480m.tif")

# # State owned water bottoms
sowb           <- raster::raster("state_owned_water_bottoms_480m.tif")

# ========================================

# cool months
# sal_cool  <- raster::stack("si_salinity_cool_mask.tif") %>% 
#   setNames(c("salinity_min_cool_03_03","salinity_min_cool_10_10"))
# 
# # warm months
# sal_warm  <- raster::stack("si_salinity_warm_mask.tif") %>% 
#   setNames(c("salinity_min_warm_03_03","salinity_min_warm_10_10"))
# 
# # average
# sal_avg   <- raster::stack("si_salinity_avg_mask.tif")  %>% 
#   setNames(c("salinity_avg_03_03","salinity_avg_10_10"))

# SI MS ---- (Warm x cool)^1/2
# si_ms <- raster::stack("si_ms.tif") %>%
#   setNames(c("si_ms_03_03","si_ms_10_10", "si_ms_mask_03_03","si_ms_mask_10_10"))
# 
# # Oyster viability ---- (OV x CV)^1/2
# si_ov <- raster::stack("si_ov.tif")  %>%
#   setNames(c("si_ov_03_03","si_ov_10_10", "si_ov_mask_03_03","si_ov_mask_10_10"))

# =======================
# ---- AOC (CV x OV) ----
# =======================

# aoc_shallow <- raster::stack("aoc_shallow.tif") %>%
#   setNames(c("aoc_shallow_03_03", "aoc_shallow_10_10"))
# 
# aoc_deep <- raster::stack("aoc_deep.tif") %>%
#   setNames(c("aoc_deep_03_03", "aoc_deep_10_10"))

# depth raster
# depth <- raster::raster(paste0(path, "depth_inundation/depth_inundation_01_01_480m_resample.tif"))

# landwater
# land_sf        <- readRDS("land_polygon_simple_v4.rds") %>%
#         st_transform(26915) %>%
#         st_transform(4326) %>%
#         mutate(label = "2023 MP Land (Year 1)") 
        # dplyr::select(land = landwater_binary_mp2023, label, geometry)

# LDH polygon
# ldh <- readRDS("ldh_classifications.rds") %>%
#           st_transform(26915) %>%
#           st_transform(4326) %>%
#           mutate(
#               Status = case_when(
#                 Status == "open" ~ "Open",
#                 Status == "Closed" ~ "Closed",
#                 Status == "intermed" ~ "Intermediate"
#                 )
#               )

# output$testMap        <- renderLeaflet({
#     test_basemap()
#   })



# # Initialize Maps
output$cvMap        <- renderLeaflet({
    cv_basemap(
      si_road      = si_road,
      si_fetch     = si_fetch,
      si_sed_dep   = si_sed_dep,
      cv           = cv
    )
  })
#
output$ovMap        <- renderLeaflet({
    ov_basemap(
      si_sal      = si_sal,
      si_ms       = si_ms,
      si_ov       = si_ov
      )
  })
#
output$aocMap        <- renderLeaflet({
    aoc_basemap(
      aoc          = aoc,
      aoc_areas    = aoc_areas,
      waterways    = waterways,
      sowb         = sowb,
      cup          = cup
    )
  })


# CSS + Yaml headers + colors
# 678d91
# navbar:
  # - { icon: "fa-question-circle", href: "https://github.com/anguswg-ucsb/cpra_dashboard", align: right }
#487e8c
# CSS to adjust tab font size
# .active {
#   font-size:25px;
# }
```

AOC model
=====================================
Inputs {.sidebar}
----------------------------------------------------
***
### **Oyster Resource Zones**


***

###
```{r}
useShinyalert(rmd = TRUE)
actionButton(
  "modelRunHelpButton",
  label = "Meta data"
  # class = "btn-primary btn-lg",
  # icon("question")
  )

observeEvent(input$modelRunHelpButton, {
  shinyalert(title               = " ",
             closeOnClickOutside = TRUE,
             showCancelButton    = TRUE,
             html                = TRUE,
             text                =
              HTML('
                <table class="table">
                  <h6><strong>Commercial Viability</strong></h6>
                      <thead>
                        <tr>
                          <th scope="col">Layer</th>
                          <th scope="col">Description</th>
                          </tr>
                        </thead>
                        <tbody>
                         <tr>
                            <td><strong>Fetch</strong></td>
                            <td>Average exposure to open water. Provides a proxy for wave energy that could affect AOC operations </td>
                            </tr>
                         <tr>
                            <td><strong>Roads</strong></td>
                            <td>Straight line distance to nearest road. Provides a metric for ease of access.</td>
                         </tr>
                         <tr>
                            <td><strong>Sediment Deposition</strong></td>
                            <td> Sediment deposition rate. Provides a measure of AOC level of effort to reduce effects of sedimentation.</td>
                         </tr>
                         <tr>
                            <td><strong>Shallow water CV</strong></td>
                            <td>Index of commercial viability for AOC operations in shallow water based on fetch, road distance, and sediment deposition </td>
                         </tr>
                         <tr>
                            <td><strong>Deep water CV</strong></td>
                            <td>Index of commercial viability for AOC operations in deep water based on fetch and sediment deposition </td>
                         </tr>
                    </tbody>
                </table>
                         <table class="table">
                          <h6><strong>Oyster Viability</strong></h6>
                      <thead>
                        <tr>
                          <th scope="col">Layer</th>
                          <th scope="col">Description</th>
                          </tr>
                        </thead>
                        <tbody>
                          <tr>
                            <td><strong>Cool month min salinity</strong></td>
                            <td>Suitability index based on cool month minimum salinity </td>
                            </tr>
                         <tr>
                            <td><strong>Warm month min salinity</strong></td>
                            <td> Suitability index based on warm month minimum salinity</td>
                         </tr>
                         <tr>
                            <td><strong>Annual mean salinity</strong></td>
                            <td> Suitability index based on annual average salinity </td>
                         </tr>
                         <tr>
                            <td><strong>SI MS</strong></td>
                            <td>Suitability index based on combination of cool and warm month minimum salinity</td>
                         </tr>
                         <tr>
                            <td><strong>SI OV</td>
                            <td>Oyster viability index based on cool and warm month minimum salinity and annual average salinity</td>
                         </tr>
                         <tr>
                            <td><strong>AOC Shallow</strong></td>
                            <td>AOC suitability index for shallow water operations based on oyster viability and commercial viability</td>
                            </tr>
                         <tr>
                            <td><strong>AOC Deep</strong></td>
                            <td>AOC suitability index for deep water operations based on oyster viability and commercial viability </td>
                         </tr>
                    </tbody>
                </table>
                <table class="table">
                 <h6><strong>AOC</strong></h6>
                      <thead>
                        <tr>
                          <th scope="col">Layer</th>
                          <th scope="col">Description</th>
                          </tr>
                        </thead>
                        <tbody>
                         <tr>
                            <td><strong>AOC Shallow</strong></td>
                            <td>AOC suitability index for shallow water operations based on oyster viability and commercial viability</td>
                            </tr>
                         <tr>
                            <td><strong>AOC Deep</strong></td>
                            <td>AOC suitability index for deep water operations based on oyster viability and commercial viability </td>
                         </tr>
                         <tr>
                            <td><strong>USACE Navigation Channels</strong></td>
                            <td>Reference layer showing navigation channels, which may create regulatory limitations on AOC operations</td>
                         </tr>
                         <tr>
                            <td><strong>State owned water bottoms</strong></td>
                            <td>Reference layer showing state owned water bottoms, where AOC operations would be allowed</td>
                         </tr>
                         <tr>
                            <td><strong>Coastal Use Permits</strong></td>
                            <td>Reference layer showing coastal use permits, which may create regulatory limits on AOC operations </td>
                         </tr>
                         <tr>
                            <td><strong>CPRA Projects</strong></td>
                            <td>Reference layer showing integrated protection projects, which may create regulatory limitations on AOC operations</td>
                         </tr>
                    </tbody>
                </table>'
                )
             )
})
```

Column
-----------------------------------------------------------------------
### Commercial viability
```{r}
# Column {data-width=250}
leafletOutput("cvMap")
```

```{r context = "server"}
# tags$html(HTML(paste0(
#     HTML(
#       '<div class="modal fade" id="infobox1" role="dialog"><div class="modal-dialog"><!-- Modal content--><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button>'
#     ),
# 
#     # Header / Title
#     HTML("<strong>Meta data</strong>"),
#     HTML(
#       '</div><div class="modal-body">'
#     ),
#     HTML('
# <table class="table">
#       <thead>
#         <tr>
#           <th scope="col">Layer</th>
#           <th scope="col">Description</th>
#           </tr>
#         </thead>
#         <tbody>
#          <tr>
#             <td><strong>Fetch</strong></td>
#             <td>Average exposure to open water. Provides a proxy for wave energy that could affect AOC operations </td>
#             </tr>
#          <tr>
#             <td><strong>Roads</strong></td>
#             <td>Straight line distance to nearest road. Provides a metric for ease of access.</td>
#          </tr>
#          <tr>
#             <td><strong>Sediment Deposition</strong></td>
#             <td> Sediment deposition rate. Provides a measure of AOC level of effort to reduce effects of sedimentation.</td>
#          </tr>
#          <tr>
#             <td><strong>Shallow water CV</strong></td>
#             <td>Index of commercial viability for AOC operations in shallow water based on fetch, road distance, and sediment deposition </td>
#          </tr>
#          <tr>
#             <td><strong>Deep water CV</strong></td>
#             <td>Index of commercial viability for AOC operations in deep water based on fetch and sediment deposition </td>
#          </tr>
#     </tbody>
# </table>'
#     ),
#     # Closing divs
#     HTML('</div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div>')
#   )))
```

### Oyster viability
```{r}
# Column {data-width=250}
leafletOutput("ovMap")
```

```{r context = "server"}
# Make maps track eachother when interacted with
observe({ # Observer to respond to zoom / pan of baseMap1 and apply to baseMap2
    coords  <- input$aocMap_center
    zoom    <- input$aocMap_zoom
    print(coords)
    print(zoom)
    if (!is.null(coords)) {
      leafletProxy("ovMap") %>%
        setView(lat = coords$lat, lng = coords$lng, zoom = zoom)
      leafletProxy("cvMap") %>%
        setView(lat = coords$lat, lng = coords$lng, zoom = zoom)
    }
})
```

Column 
-----------------------------------------------------------------------
### AOC (Commercial x Oyster viability)
```{r}
# Column {data-width=250}
# leafletOutput("testMap")

leafletOutput("aocMap")
```


```{r context = "server"}
# click on refresh button
# observeEvent(input$my_easy_button, { output$testMap = renderMap() })
# tags$html(HTML(paste0(
#     HTML(
#       '<div class="modal fade" id="infobox2" role="dialog"><div class="modal-dialog"><!-- Modal content--><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button>'
#     ),
# 
#     # Header / Title
#     HTML("<strong>Meta data</strong>"),
#     HTML(
#       '</div><div class="modal-body">'
#     ),
#     HTML('
#       <table class="table">
#             <thead>
#               <tr>
#                 <th scope="col">Layer</th>
#                 <th scope="col">Description</th>
#                 </tr>
#               </thead>
#               <tbody>
#                <tr>
#                   <td><strong>AOC Shallow</strong></td>
#                   <td>AOC suitability index for shallow water operations based on oyster viability and commercial viability</td>
#                   </tr>
#                <tr>
#                   <td><strong>AOC Deep</strong></td>
#                   <td>AOC suitability index for deep water operations based on oyster viability and commercial viability </td>
#                </tr>
#                <tr>
#                   <td><strong>USACE Navigation Channels</strong></td>
#                   <td>Reference layer showing navigation channels, which may create regulatory limitations on AOC operations</td>
#                </tr>
#                <tr>
#                   <td><strong>State owned water bottoms</strong></td>
#                   <td>Reference layer showing state owned water bottoms, where AOC operations would be allowed</td>
#                </tr>
#                <tr>
#                   <td><strong>Coastal Use Permits</strong></td>
#                   <td>Reference layer showing coastal use permits, which may create regulatory limits on AOC operations </td>
#                </tr>
#                <tr>
#                   <td><strong>CPRA Projects</strong></td>
#                   <td>Reference layer showing integrated protection projects, which may create regulatory limitations on AOC operations</td>
#                </tr>
#           </tbody>
#       </table>'
#     ),
#     # Closing divs
#     HTML('</div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div>')
#   )))
#   observeEvent(input$my_easy_button, {
#     str(input$my_easy_button)
#   })
# 
#   observeEvent(input$my_easy_button, {
#     # ---- info box ----
#           info_box <- HTML(paste0(
#     HTML(
#       '<div class="modal fade" id="infobox" role="dialog"><div class="modal-dialog"><!-- Modal content--><div class="modal-content"><div class="modal-header"><button type="button" class="close" data-dismiss="modal">&times;</button>'
#     ),
# 
#     # Header / Title
#     HTML("<strong>Meta data</strong>"),
#     HTML(
#       '</div><div class="modal-body">'
#     ),
#     HTML('
# <table class="table">
#       <thead>
#         <tr>
#           <th scope="col">Layer</th>
#           <th scope="col">Description</th>
#           </tr>
#         </thead>
#         <tbody>
#          <tr>
#             <td><strong>Cool month min salinity</strong></td>
#             <td>Suitability index based on cool month minimum salinity </td>
#             </tr>
#          <tr>
#             <td><strong>Warm month min salinity</strong></td>
#             <td> Suitability index based on warm month minimum salinity</td>
#          </tr>
#          <tr>
#             <td><strong>Annual mean salinity</strong></td>
#             <td> Suitability index based on annual average salinity </td>
#          </tr>
#          <tr>
#             <td><strong>SI MS</strong></td>
#             <td>Suitability index based on combination of cool and warm month minimum salinity</td>
#          </tr>
#          <tr>
#             <td><strong>SI OV</td>
#             <td>Oyster viability index based on cool and warm month minimum salinity and annual average salinity</td>
#          </tr>
#     </tbody>
# </table>'
#     ),
#     # Closing divs
#     HTML('</div><div class="modal-footer"><button type="button" class="btn btn-default" data-dismiss="modal">Close</button></div></div>')
#   ))
#           
#           
#     # ---- append info box to leaflet ----
#     leafletProxy("testMap") %>% 
#       htmlwidgets::appendContent(info_box)
#   })
```















